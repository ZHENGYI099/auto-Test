# Test Scenario: Check agent registration when network issue
Steps,Action,Expect result
1,Open Windows defender firewall and click Advanced settings,
2,"Click Outbound Rules -> New Rule -> Rule Type choose Port -> Select TCP and Specific local ports set to 5671 -> Select ""Block the connection"" in Action -> Name it as ""Block amqp"" and click ""finish""",
3,"Restart ""Microsoft Cloud Managed Desktop Extension"" in service panel if it didn't be uninstalled, or Reinstall the agent by command: msiexec /i cmdextension.msi SVCENV=Test",
4,"Check ""CMDExtension.log""","There should be a log ""DeviceClient created and opened successfully"" after step 3."
5,"Stop ""Microsoft Cloud Managed Desktop Extension"" in service panel",
6,"Click Outbound Rules -> New Rule -> Rule Type choose Port -> Select TCP and Specific local ports set to 443 -> Select ""Block the connection"" in Action -> Name it as ""Block https"" and click ""finish""",
7,"Start ""Microsoft Cloud Managed Desktop Extension"" in service panel and wait for 35 minutes.",
8,"Check ""CMDExtension.log""","There should be several logs ""Connect to IoTHub failed with a generic exception"" after step7"
9,"Go to  ""Windows Defender Firewall with Advanced Security"" panel, right click on ""Block https"" to disable it and wait for 10 minutes",
10,"Check ""CMDExtension.log""","There should be a log ""DeviceClient created and opened successfully"" after step 9."
11,"Test Cleanup:


Disable or delete Outboud rules ""Block amqp"" ""Block https"". If you disable it, step2 and step 6 can be updated to enable the rule instead of create it in next time.",
