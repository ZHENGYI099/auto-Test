# Test Scenario: CMD Agent unified channel with mulitiple partners
Steps,Action,Expect result
1,Install cmd agent with correct SVCENV (Test) and wait for 1 minute,"Open registry ""Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CloudManagementDesktop\Extension\Settings"" Partners should contain more than 1 partner."
2,"Wait for 15 minutes and check logs in ""C:\ProgramData\Microsoft\CMDExtension\Logs"" folder.","1. MessageSenderPlugin.log contains log ""MessageSenderPlugin execute result is: {""TotalSize"":xxx,""Count"":x,""CommunicationChannel"":""IoTHub""}"" xxx and xx are larger than 0.
2. HeartbeatPlugin.log contains 1 success log starts with ""{""ServiceStatus"":""Running"",""AgentVersion"":"""
3,"Forbidden iothub endpoint:
a. Open registry ""Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CloudManagementDesktop\Extension\Settings"" and copy the value of IoTHostName 
b. Run nslookup {IoTHostName value}, copy the Address in Non-authoritative answer.

a. Create a rule to forbid this address: follow the “Block IP Address in Windows Firewall” step: https://windowsloop.com/block-website-or-ip-address-in-windows-firewall/ (Make sure the protocol type is any)",
4,"Wait for 12 hours (If the device has been shutdown, please wait 2 more hours after  device start up) and check logs in ""C:\ProgramData\Microsoft\CMDExtension\Logs"" folder.","1. MessageSenderPlugin.log only contains ""MessageSenderPlugin execute result is: {""TotalSize"":0,""Count"":0,""CommunicationChannel"":""IoTHub""}"" after step3.

2. HeartbeatPlugin.log contains multiple success log starts with ""{""ServiceStatus"":""Running"",""AgentVersion"":"" "
5,"Disable the rule in step3, wait for 1 hour and check logs in ""C:\ProgramData\Microsoft\CMDExtension\Logs"" folder.","1. MessageSenderPlugin.log contains log ""MessageSenderPlugin execute result is: {""TotalSize"":xxx,""Count"":x,""CommunicationChannel"":""IoTHub""}"" xxx and xx are larger than 0 after step4"
6,"Uninstall cmd agent and clear log folder ""C:\ProgramData\Microsoft\CMDExtension\Logs""",
7,Enable the firewall rule,
8,Install cmd agent,
9,"Wait for 5 minutes and check logs in ""C:\ProgramData\Microsoft\CMDExtension\Logs"" folder.","1. MessageSenderPlugin.log and HeartbeatPlugin.log didn't exist
2. CMDExtension.log doesn't contain ""DeviceClient created and opened successfully."""
10,"Cleanup: uninstall agent, disable outbound port rules in step3",
